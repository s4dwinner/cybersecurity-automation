#!/bin/bash

# =============================================================================
# Malware Analysis Helper
# Author: Ahmed Elhiouli
# Description: Initial triage and analysis of suspicious files
# Usage: ./malware-analysis-helper.sh -f suspicious_file.exe
# =============================================================================

set -euo pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Global variables
TARGET_FILE=""
OUTPUT_DIR="malware_analysis"
HASH_FILE=""
STRING_OUTPUT=""

# Banner
print_banner() {
    echo -e "${RED}"
    echo "=========================================="
    echo "        Malware Analysis Helper"
    echo "           Ahmed Elhiouli"
    echo "    USE WITH CAUTION IN ISOLATED ENV"
    echo "=========================================="
    echo -e "${NC}"
}

# Usage information
usage() {
    echo "Usage: $0 -f <target_file> [-o <output_dir>]"
    echo "Options:"
    echo "  -f  Target file to analyze"
    echo "  -o  Output directory (default: malware_analysis)"
    exit 1
}

# Safety checks
safety_checks() {
    if [[ ! -f "$TARGET_FILE" ]]; then
        echo -e "${RED}[ERROR] File not found: $TARGET_FILE${NC}"
        exit 1
    fi
    
    if [[ ! -r "$TARGET_FILE" ]]; then
        echo -e "${RED}[ERROR] Cannot read file: $TARGET_FILE${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}[SAFETY] Always analyze malware in isolated environments!${NC}"
}

# Check dependencies
check_dependencies() {
    local deps=("file" "strings" "objdump" "readelf")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing+=("$dep")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${YELLOW}[WARNING] Missing tools: ${missing[*]}${NC}"
        echo "Some features may not work properly"
    fi
}

# File information gathering
get_file_info() {
    echo -e "\n${BLUE}[ANALYSIS] File Information${NC}"
    
    echo -e "${YELLOW}Basic File Info:${NC}"
    file "$TARGET_FILE" | tee "$OUTPUT_DIR/file_info.txt"
    
    echo -e "\n${YELLOW}File Size:${NC}"
    du -h "$TARGET_FILE" | cut -f1
    
    echo -e "\n${YELLOW}File Type (Detailed):${NC}"
    if command -v exiftool &> /dev/null; then
        exiftool "$TARGET_FILE" | head -20
    else
        echo "Install exiftool for detailed file information"
    fi
}

# Hash generation
generate_hashes() {
    echo -e "\n${BLUE}[ANALYSIS] Hash Generation${NC}"
    
    HASH_FILE="$OUTPUT_DIR/hashes.txt"
    
    echo -e "${YELLOW}MD5:${NC}" | tee -a "$HASH_FILE"
    md5sum "$TARGET_FILE" | tee -a "$HASH_FILE"
    
    echo -e "${YELLOW}SHA1:${NC}" | tee -a "$HASH_FILE"
    sha1sum "$TARGET_FILE" | tee -a "$HASH_FILE"
    
    echo -e "${YELLOW}SHA256:${NC}" | tee -a "$HASH_FILE"
    sha256sum "$TARGET_FILE" | tee -a "$HASH_FILE"
}

# String extraction
extract_strings() {
    echo -e "\n${BLUE}[ANALYSIS] String Extraction${NC}"
    
    STRING_OUTPUT="$OUTPUT_DIR/strings.txt"
    
    echo -e "${YELLOW}ASCII Strings:${NC}"
    strings "$TARGET_FILE" > "$STRING_OUTPUT"
    
    local string_count
    string_count=$(wc -l < "$STRING_OUTPUT")
    echo "Extracted $string_count strings"
    
    # Look for interesting patterns
    echo -e "\n${YELLOW}Suspicious Patterns Found:${NC}"
    local patterns=("http://" "https://" ".exe" ".dll" "cmd.exe" "powershell" "regedit" "admin" "password")
    
    for pattern in "${patterns[@]}"; do
        local count
        count=$(grep -c -i "$pattern" "$STRING_OUTPUT" || true)
        if [[ $count -gt 0 ]]; then
            echo -e "${RED}[SUSPICIOUS] '$pattern': $count occurrences${NC}"
        fi
    done
    
    # Show top URLs if any
    if grep -q -i "http" "$STRING_OUTPUT"; then
        echo -e "\n${YELLOW}Top URLs Found:${NC}"
        grep -i "http" "$STRING_OUTPUT" | head -5
    fi
}

# Binary analysis
analyze_binary() {
    if ! file "$TARGET_FILE" | grep -q "ELF\|PE\|Mach-O"; then
        return
    fi
    
    echo -e "\n${BLUE}[ANALYSIS] Binary Analysis${NC}"
    
    # ELF analysis
    if file "$TARGET_FILE" | grep -q "ELF"; then
        echo -e "${YELLOW}ELF Header:${NC}"
        readelf -h "$TARGET_FILE" | head -10
        
        echo -e "\n${YELLOW}Sections:${NC}"
        readelf -S "$TARGET_FILE" | head -15
    fi
    
    # PE analysis (if pefile available)
    if command -v objdump &> /dev/null && file "$TARGET_FILE" | grep -q "PE32"; then
        echo -e "${YELLOW}Imported Functions:${NC}"
        objdump -x "$TARGET_FILE" | grep -i "DLL Name" | head -10
    fi
}

# Quick threat intelligence
threat_intel_check() {
    echo -e "\n${BLUE}[INTEL] Quick Threat Intelligence${NC}"
    
    if [[ -f "$HASH_FILE" ]]; then
        local sha256_hash
        sha256_hash=$(grep "SHA256" "$HASH_FILE" | cut -d' ' -f1)
        
        echo -e "${YELLOW}VirusTotal Search:${NC}"
        echo "https://www.virustotal.com/gui/file/$sha256_hash"
        
        echo -e "${YELLOW}Hybrid Analysis Search:${NC}"
        echo "https://www.hybrid-analysis.com/search?query=$sha256_hash"
    fi
}

# Generate report
generate_report() {
    local report_file="$OUTPUT_DIR/analysis_report.txt"
    
    {
        echo "Malware Analysis Report"
        echo "======================"
        echo "File: $TARGET_FILE"
        echo "Date: $(date)"
        echo "Analyst: Ahmed Elhiouli"
        echo ""
        echo "HASHES:"
        cat "$HASH_FILE"
        echo ""
        echo "SUSPICIOUS INDICATORS:"
        grep -i "http\|.exe\|.dll\|powershell\|cmd.exe" "$STRING_OUTPUT" | head -20
    } > "$report_file"
    
    echo -e "\n${GREEN}[REPORT] Analysis report: $report_file${NC}"
}

# Main analysis function
run_analysis() {
    echo -e "${GREEN}[START] Analysis initiated for: $TARGET_FILE${NC}"
    
    # Create output directory
    mkdir -p "$OUTPUT_DIR"
    
    # Run analysis phases
    safety_checks
    get_file_info
    generate_hashes
    extract_strings
    analyze_binary
    threat_intel_check
